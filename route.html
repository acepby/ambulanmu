<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Route AmbulanMu</title>
        <link
            rel="stylesheet"
            type="text/css"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"/>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
        

        <style>
            #map {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
        </style>
    </head>
    <body>
        <div id="map">
        </div>
        //
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"
            type="text/javascript">
        </script>
        <script
			src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-realtime/2.2.0/leaflet-realtime.min.js"
			type="text/javascript">
		</script>
		
		<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

		<!-- Include this library for mobile touch support  -->
		<script src="http://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.2/jquery.ui.touch-punch.min.js"></script>


		<!-- <script src="dashboard/static/js/SliderControl.js"></script> -->
		<script src="https://cdn.jsdelivr.net/gh/Falke-Design/LeafletSlider@latest/dist/leaflet.SliderControl.min.js"></script>
		
		<!-- After Leaflet script -->
		<script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"></script>
        //
        <script>
            // set up map
            
            var center = [-1.328499, 121.589203];
            var map = L.map('map').setView(center, 6);
            var url = "data/ambulan.geojson";   //{{url_for('data_source',filename='ambulan.geojson')}};
            var myOldId= null;
            /*
            var myroute = [[]];
            var myfeature =[]; 
            var mygeojson = {"type": "FeatureCollection", "features": []} ;
            */	
            //icon 
            var startIcon = L.icon({
				iconSize: [48, 48],
				iconAnchor: [24, 24],
				popupAnchor:  [1, -24],
				iconUrl: 'dashboard/static/icons/awal.png'
			});
			
			var endIcon = L.icon({
				iconSize: [48, 48],
				iconAnchor: [24, 24],
				popupAnchor:  [1, -24],
				iconUrl: 'dashboard/static/icons/latest.png'
			});
			
			
			
			var realtime= L.realtime( function(success,error){
					fetch(url)
					.then(function(response){return response.json();})
					.then(function(data){
							//console.log(data.features.length);
							var mydata = data.features;
							var myroute = [[]];
							var myfeature =[]; 
							var mygeojson = {"type": "FeatureCollection", "features": []} ;
																				
							//console.log(mydata);
							mydata.forEach(function(item){
								if(item.properties.mid && myOldId != item.properties.mid){
									myOldId = item.properties.mid;
									//console.log(item.properties.driver);
									
									myroute[myOldId]=[];
									driver = item.properties.driver;
									upid =[item.properties.upid];
									time =[item.properties.waktu];
									state=[item.properties.state];
									//color= '#' + Math.floor(myOldId + Math.random()*16777215).toString(16);
									//console.log(color);
									
									//myroute[myOldId][0] = item.geometry.coordinates;
									myroute[myOldId] ={type:'Feature',
										properties:{ id:myOldId, driver: driver,upid: upid,state:state,time:time},
										geometry:{type:'LineString',coordinates:[item.geometry.coordinates]}};
									
								} else{
									myroute[myOldId].properties.state.push(item.properties.state);
									myroute[myOldId].properties.upid.push(item.properties.upid);
									myroute[myOldId].properties.time.push(item.properties.waktu);
									myroute[myOldId].geometry.coordinates.push(item.geometry.coordinates);
								}
								
							});
							//console.log('data',data);
							
							myroute.forEach(function(key){
								//console.log(key);
								if(key !=0){
										//console.log(key.properties.id);
									myfeature.push(key);
									/*
									if(!myfeature[key])
										myfeature[key] = key;
									else
										myfeature[key].push(key);
									*/
								}
							}); 
							
							mygeojson.features.push.apply(mygeojson.features,myfeature)
							//updating list
							success(
							mygeojson
							); 	
						})
					.catch(error);
				},{
					interval:3000,
					style: function(feature){
							d = '#' + Math.floor(feature.properties.id + Math.random()*16777215).toString(16);
							return {
								"color": d,
								"opacity": 0.7
							}
						},
					onEachFeature: markerPointer
					}
			).addTo(map);
			
			//addmarker
			function markerPointer(feature,layer){
				numpts = feature.geometry.coordinates.length;
				//console.log(numpts);
				var beg = feature.geometry.coordinates[0];
				var end = feature.geometry.coordinates[numpts-1];
				var akhir = numpts-1;
				/*
				console.log(feature.properties.id);
				if(end != beg)
					console.log('upid',feature.properties.state[numpts -1]);
				*/

				L.marker([beg[1],beg[0]],{icon:startIcon})
				.bindPopup(function(){
						return '<h3>' + feature.properties.driver + '</h3>' +
								'<p>' + feature.properties.state[0] +'</p>' +
								'<b>'+ feature.properties.upid[0] +'</b>'+
								'<p>' + new Date(feature.properties.time[0]);
				}).addTo(map);
				
				if(end != beg)
					L.marker([end[1],end[0]],{icon:endIcon})
					.bindPopup(function(){
						//return '<b>'+ akhir +'</b>';
						
						return '<h3>' + feature.properties.driver + '</h3>' +
								'<p>' + feature.properties.state[akhir] +'</p>' +
								'<b>'+ feature.properties.upid[akhir] +'</b>'+
								'<p>' + new Date(feature.properties.time[akhir])+'</p>' +
								'<p> Jarak :'+ distance(beg[1],beg[0],end[1],end[0])+'km </p>';
						
					}).addTo(map);
				
			};
			
			function colorLine(feature){
					
			};
			
			//jarak ambil dari https://stackoverflow.com/a/21623206
			function distance(lat1, lon1, lat2, lon2) {
				var p = 0.017453292519943295;    // Math.PI / 180
				var c = Math.cos;
				var a = 0.5 - c((lat2 - lat1) * p)/2 + 
						c(lat1 * p) * c(lat2 * p) * 
						(1 - c((lon2 - lon1) * p))/2;

				return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
			};
			
			//console.log('mygeo',mygeojson);
			//console.log(realtime._features);
		         
            //watermark logo
            L.Control.Support = L.Control.extend({
					onAdd: function(map){
						var img = L.DomUtil.create('img');
						img.src ='https://github.com/azhargiri/mit-logo/raw/master/logo_mit_300.png';
						img.style.width ='52px';
						img.title ='mitsociety.id';
						return img;						
					},
					
					onRemove: function(map){
					}
			})
			
			
			
			L.control.support = function(opts){
					return new L.Control.Support(opts)
				}
		
			//console.log(test);
			
						
			
					
			 L.control.support({position:'bottomleft'}).addTo(map); 
            
            // Stamen's Toner basemap
            L.tileLayer(
                'https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
                    attribution: 'Map tiles by <a href="http://stamen.com">' +
                        'Stamen Design</a>, under' +
                        '<a href="http://creativecommons.org/licenses/by/3.0">' +
                        'CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">' +
                        'OpenStreetMap</a>, under' +
                        '<a href="http://www.openstreetmap.org/copyright">ODbL</a>.'
            }).addTo(map);
            
            realtime.once('update', function() {
				map.fitBounds(realtime.getBounds(), {maxZoom: 6});
			});
			
			console.log('real',realtime)
			
			
                        
        </script>
    </body>
</html>
